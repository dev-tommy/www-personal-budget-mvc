{% extends "base.html" %}
{% set settings_active = 'active' %}

{% block title %}Ustawienia{% endblock %}

{% block modal %}
    {% include 'Settings/askAddModal.html' %}
    {% include 'Settings/askDeleteModal.html' %}
    {% include 'Settings/askEditModal.html' %}
    {% include 'Settings/successModal.html' %}
    {% include 'Settings/failModal.html' %}
{% endblock %}

{% block javascript %}
    <script>
        function refreshCategoriesAndMethods(elementSource)
        {
            var url = "";
            var select;
            switch (elementSource) {
                case 'income':
                    url = "/get-all-incomes-categories";
                    select = $('#incomeCategory');
                    break;
                case 'expense':
                    url = "/get-all-expenses-categories";
                    select = $('#expenseCategory');
                    break;
                case 'payment':
                    url = "/get-all-payments-methods";
                    select = $('#paymentMethod');
                    break;
                default:
                    return;
            }
            $.post(
                url,
                function (answer) {
                    select.empty();
                    var categories = JSON.parse(answer);
                    $.each(categories, function (i, categorie) {
                        select
                            .append($("<option/>")
                                .attr("value", categorie["id"])
                                .text(categorie["name"]));

                        if (!isNaN(categorie["expense_limit"]) && categorie["expense_limit"] != null) {
                            select
                                .append($("<option/>")
                                    .attr("id", "limit"+categorie['id'])
                                    .attr("value", categorie["id"])
                                    .attr("limit", categorie["expense_limit"])
                                    .attr("class", "")
                                    .attr("disabled", true)
                                    .addClass("text-danger")
                                    .css({
                                        "font-style": "italic",
                                        "font-style": "bold",
                                        "font-size": "0.6em"
                                    })
                                    .html('  &nbsp;&nbsp; &#8627; Limit: ' + categorie["expense_limit"] + ' [z≈Ç/m-c]'));
                        }
                    });
                }
            );
        }
        $(document).ready(function () {
            var elementSource = "";
            var elementName = "";
            var elementId = 0;
            var elementLimit = 0.0;

            $('#askAdd').on('show.bs.modal', function () {
                if (elementSource == "expense") {
                    $('[limit-show]').removeClass("d-none");
                }
            })
            $('#askAdd').on('hidden.bs.modal', function () {
                $('[limit-show]').addClass("d-none");

                refreshCategoriesAndMethods(elementSource);
            })

            $('#askEdit').on('show.bs.modal', function () {
                if (elementSource == "expense") {
                    $('[limit-show]').removeClass("d-none");
                    $("#editLimit").prop("checked", false);
                }
            })

            $('#askEdit').on('hidden.bs.modal', function () {
                $('[limit-show]').addClass("d-none");
                refreshCategoriesAndMethods(elementSource);
            })

            $('#askDelete').on('hidden.bs.modal', function () {
                refreshCategoriesAndMethods(elementSource);
            })

            $("#incomeCategoryAdd").click(function () {
                elementSource = "income";
                $("#askAddModalBody").val($.trim($("#incomeCategoryName").val()));
                elementName = $.trim($("#incomeCategoryName").val());
                $("#askAdd").modal();
            });
            $("#incomeCategoryRemove").click(function () {
                elementSource = "income";
                $("#askDeleteModalBody").val($.trim($("#incomeCategory option:selected").text()));
                elementId = $("#incomeCategory option:selected").val();
                $("#askDelete").modal();
            });
            $("#incomeCategoryEdit").click(function () {
                elementSource = "income";
                $("#askEditModalBody").val($.trim($("#incomeCategory option:selected").text()));
                elementId = $("#incomeCategory option:selected").val();
                $('#askEdit').on('shown.bs.modal', function () {
                    $('#askEditModalBody').focus();
                })
                $("#askEdit").modal();
            });

            $("#expenseCategoryAdd").click(function () {
                elementSource = "expense";
                $("#askAddModalBody").val($.trim($("#expenseCategoryName").val()));
                elementName = $.trim($("#expenseCategoryName").val());
                $("#askAdd").modal();

            });
            $("#expenseCategoryRemove").click(function () {
                elementSource = "expense";
                $("#askDeleteModalBody").val($.trim($("#expenseCategory option:selected").text()));
                elementId = $("#expenseCategory option:selected").val();
                $("#askDelete").modal();
            });
            $("#expenseCategoryEdit").click(function () {
                elementSource = "expense";
                $("#askEditModalBody").val($.trim($("#expenseCategory option:selected").text()));
                elementId = $("#expenseCategory option:selected").val();
                $("#editLimitValue").val($("#limit"+elementId).attr("Limit"));
                $('#askEdit').on('shown.bs.modal', function () {
                    $('#askEditModalBody').focus();
                })
                $("#askEdit").modal();
            });

            $("#paymentMethodAdd").click(function () {
                elementSource = "payment";
                $("#askAddModalBody").val($.trim($("#paymentMethodName").val()));
                elementName = $.trim($("#paymentMethodName").val());
                $("#askAdd").modal();
            });
            $("#paymentMethodRemove").click(function () {
                elementSource = "payment";
                $("#askDeleteModalBody").val($.trim($("#paymentMethod option:selected").text()));
                elementId = $("#paymentMethod option:selected").val();
                $("#askDelete").modal();
            });
            $("#paymentMethodEdit").click(function () {
                elementSource = "payment";
                $("#askEditModalBody").val($.trim($("#paymentMethod option:selected").text()));
                elementId = $("#paymentMethod option:selected").val();
                $('#askEdit').on('shown.bs.modal', function () {
                    $('#askEditModalBody').focus();
                })
                $("#askEdit").modal();
            });

            $("#userNameEdit").click(function () {
                elementSource = "user";
                elementId = 1;
                $("#askEditModalBody").val($.trim($("#userName").val()));
                $('#askEdit').on('shown.bs.modal', function () {
                    $('#askEditModalBody').focus();
                })
                $("#askEdit").modal();
            });

            $("#userEmailEdit").click(function () {
                elementSource = "user";
                elementId = 2;
                $("#askEditModalBody").val($.trim($("#userEmail").val()));
                $('#askEdit').on('shown.bs.modal', function () {
                    $('#askEditModalBody').focus();
                })
                $("#askEdit").modal();
            });

            $("#userPasswordEdit").click(function () {
                elementSource = "user";
                elementId = 3;
                $("#askEditModalBody").val("");
                $('#askEdit').on('shown.bs.modal', function () {
                    $('#askEditModalBody').focus();
                })
                $("#askEdit").modal();
            });

            $("#addElement").click(function () {
                elementLimit = $.trim($("#addLimitValue").val());
                $.post(
                    "/element-add",
                    {
                        source: elementSource,
                        name: elementName,
                        limit: elementLimit
                    },
                    function (answer, status) {
                        if (status == "success") {
                            $("#success").find(".modal-body").html(answer);
                            $("#success").modal();
                        } else {
                            $("#fail").modal();
                        }
                    }
                );
            });

            $("#removeElement").click(function () {
                $.post(
                    "/element-remove",
                    {
                        source: elementSource,
                        id: elementId
                    },
                    function(answer, status){
                        if (status == "success")
                        {
                            $("#success").find(".modal-body").html(answer);
                            $("#success").modal();
                        } else {
                            $("#fail").modal();
                        }
                    }
                );
            });

            $("#editElement").click(function () {
                elementName = $.trim($("#askEditModalBody").val());
                elementLimit = $.trim($("#editLimitValue").val());
                limitCheckbox = $("#editLimit").prop("checked");
                $.post(
                    "/element-edit",
                    {
                        source: elementSource,
                        id: elementId,
                        name: elementName,
                        limit: elementLimit,
                        limitCheckbox: limitCheckbox
                    },
                    function (answer, status) {
                        if (status == "success") {
                            $("#success").find(".modal-body").html(answer);
                            $("#success").modal();
                        } else {
                            $("#fail").modal();
                        }
                    }
                );
            });

            $("#addLimitValue").click(function () {
                $("#addLimit").prop('checked', true);
                $(this).removeAttr('readonly');
                $(this).focus();
            });

            $('#addLimit').click(function(){
                if($(this).prop("checked") == true){
                    $("#addLimitValue").removeAttr('readonly');
                    $("#addLimitValue").focus();
                }
                else if($(this).prop("checked") == false){
                    $("#addLimitValue").attr('readonly');
                }
            });

            $("#editLimitValue").click(function () {
                $("#editLimit").prop('checked', true);
                $(this).removeAttr('readonly');
                $(this).focus();
            });

            $('#editLimit').click(function () {
                if ($(this).prop("checked") == true) {
                    $("#editLimitValue").removeAttr('readonly');
                    $("#editLimitValue").focus();
                }
                else if ($(this).prop("checked") == false) {
                    $("#editLimitValue").attr('readonly');
                }
            });
        });
    </script>
{% endblock %}

{% block main %}
<div class="container move-under-navbar">
    <div class="row">
        <div class="col-12 col-sm-10 offset-sm-1 col-md-8 offset-md-2 col-lg-6 offset-lg-3">
            <div class="card shadow-lg mb-5 bg-white rounded">
                <div class="card-header bg-info card-topic text-center"> Ustawienia </div>
                <div class="card-body">
                    <div id="settings">
                        <div class="card mb-3">
                            {% include 'Settings/income.html' %}
                        </div>
                        <div class="card mb-3">
                            {% include 'Settings/expense.html' %}
                        </div>
                        <div class="card mb-3">
                            {% include 'Settings/payment.html' %}
                        </div>
                        <div class="card mb-3">
                            {% include 'Settings/user.html' %}
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-info text-white">

                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}